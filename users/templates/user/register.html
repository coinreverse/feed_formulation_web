{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "用户注册 - 饲料配方系统" %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">{% trans "用户注册" %}</h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ form.username.id_for_label }}" class="form-label">{% trans "用户名" %}</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <div class="text-danger">{{ form.username.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">{% trans "邮箱地址" %}</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="verification_code" class="form-label">{% trans "验证码" %}</label>
                        <div class="input-group">
                            {{ form.verification_code }}
                            <button type="button" id="send-code-btn" class="btn btn-outline-secondary">{% trans "发送验证码" %}</button>
                        </div>
                        {% if form.verification_code.errors %}
                            <div class="text-danger">{{ form.verification_code.errors }}</div>
                        {% endif %}
                        <div id="code-message" class="mt-1"></div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.password1.id_for_label }}" class="form-label">{% trans "密码" %}</label>
                        {{ form.password1 }}
                        {% if form.password1.errors %}
                            <div class="text-danger">{{ form.password1.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.password2.id_for_label }}" class="form-label">{% trans "确认密码" %}</label>
                        {{ form.password2 }}
                        {% if form.password2.errors %}
                            <div class="text-danger">{{ form.password2.errors }}</div>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">{% trans "注册" %}</button>
                </form>

                <div class="text-center mt-3">
                    <p>{% trans "已有账户？" %} <a href="{% url 'login' %}">{% trans "立即登录" %}</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sendCodeBtn = document.getElementById('send-code-btn');
        const emailInput = document.getElementById('{{ form.email.id_for_label }}');
        const codeMessage = document.getElementById('code-message');

        sendCodeBtn.addEventListener('click', function() {
            const email = emailInput.value;

            if (!email) {
                codeMessage.innerHTML = '<span class="text-danger">{% trans "请先输入邮箱地址" %}</span>';
                return;
            }

            // 禁用发送按钮
            sendCodeBtn.disabled = true;
            sendCodeBtn.innerHTML = '{% trans "发送中..." %}';

            // 发送请求获取验证码
            fetch('{% url "send_verification_code" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    codeMessage.innerHTML = '<span class="text-success">' + data.message + '</span>';
                    // 倒计时60秒
                    let countdown = 60;
                    sendCodeBtn.innerHTML = `${countdown}秒后重新发送`;

                    const timer = setInterval(() => {
                        countdown--;
                        sendCodeBtn.innerHTML = `${countdown}秒后重新发送`;

                        if (countdown <= 0) {
                            clearInterval(timer);
                            sendCodeBtn.disabled = false;
                            sendCodeBtn.innerHTML = '{% trans "发送验证码" %}';
                        }
                    }, 1000);
                } else {
                    codeMessage.innerHTML = '<span class="text-danger">' + data.message + '</span>';
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.innerHTML = '{% trans "发送验证码" %}';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                codeMessage.innerHTML = '<span class="text-danger">{% trans "发送失败，请稍后重试" %}</span>';
                sendCodeBtn.disabled = false;
                sendCodeBtn.innerHTML = '{% trans "发送验证码" %}';
            });
        });
    });
</script>
{% endblock %}
