{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "重置密码 - 饲料配方系统" %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">{% trans "重置密码" %}</h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">{% trans "邮箱地址" %}</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.verification_code.id_for_label }}" class="form-label">{% trans "验证码" %}</label>
                        <div class="input-group">
                            {{ form.verification_code }}
                            <button type="button" class="btn btn-outline-secondary" id="send-code-btn">
                                {% trans "发送验证码" %}
                            </button>
                        </div>
                        {% if form.verification_code.errors %}
                            <div class="text-danger">{{ form.verification_code.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.new_password1.id_for_label }}" class="form-label">{% trans "新密码" %}</label>
                        {{ form.new_password1 }}
                        {% if form.new_password1.errors %}
                            <div class="text-danger">{{ form.new_password1.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.new_password2.id_for_label }}" class="form-label">{% trans "确认新密码" %}</label>
                        {{ form.new_password2 }}
                        {% if form.new_password2.errors %}
                            <div class="text-danger">{{ form.new_password2.errors }}</div>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">{% trans "重置密码" %}</button>
                </form>

                <div class="text-center mt-3">
                    <p><a href="{% url 'login' %}">{% trans "返回登录" %}</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 添加发送验证码的JavaScript代码
document.addEventListener('DOMContentLoaded', function() {
    const sendCodeBtn = document.getElementById('send-code-btn');
    const emailInput = document.getElementById('{{ form.email.id_for_label }}');
    
    sendCodeBtn.addEventListener('click', function() {
        const email = emailInput.value;
        
        if (!email) {
            alert('{% trans "请输入邮箱地址" %}');
            return;
        }
        
        // 发送请求
        fetch('{% url "send_verification_code" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new URLSearchParams({
                'email': email
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                // 添加倒计时功能
                let countdown = 60;
                sendCodeBtn.disabled = true;
                sendCodeBtn.textContent = countdown + 's后重新发送';
                
                const timer = setInterval(() => {
                    countdown--;
                    sendCodeBtn.textContent = countdown + 's后重新发送';
                    
                    if (countdown <= 0) {
                        clearInterval(timer);
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.textContent = '{% trans "发送验证码" %}';
                    }
                }, 1000);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "发送失败，请稍后重试" %}');
        });
    });
});
</script>
{% endblock %}